{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="dashboard-container" style="max-width: 1100px; margin: 40px auto; padding: 20px;">

    <h1 style="color: var(--color-navbar); margin-bottom: 30px;">
        Tus Estad√≠sticas de Ventas:
    </h1>

    <div class="kpi-grid"
        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px;">
        <div class="kpi-card">
            <h3>Tus Ingresos</h3>
            <p class="kpi-value">${{ stats_personal.kpis.total_plata|default:"0"|floatformat:2 }}</p>
        </div>
        <div class="kpi-card">
            <h3>Tus Unidades Vendidas</h3>
            <p class="kpi-value" style="color: #2D9CDB;">{{ stats_personal.kpis.total_items|default:"0" }}</p>
        </div>
    </div>

    <div class="charts-grid">
        <div class="chart-card">
            <h3>Tus Formatos Vendidos</h3>
            <canvas id="chartFormatosPersonal"></canvas>
        </div>
        <div class="chart-card">
            <h3>Tu Actividad por Hora</h3>
            <canvas id="chartHorasPersonal"></canvas>
        </div>
    </div>

    {% if stats_global %}
    <hr style="border: 0; border-top: 4px dashed #ccc; margin: 60px 0;">

        <h1
            style="color: var(--color-navbar); border-bottom: 3px solid var(--color-acento); padding-bottom: 10px; margin-bottom: 30px;">
            üåê Dashboard Global (Admin)
        </h1>

        <div class="kpi-grid"
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px;">
            <div class="kpi-card">
                <h3>Ingresos Totales Plataforma</h3>
                <p class="kpi-value">${{ stats_global.kpis.total_plata|default:"0"|floatformat:2 }}</p>
            </div>

            <div class="kpi-card">
                <h3>Total Unidades Vendidas</h3>
                <p class="kpi-value" style="color: #2D9CDB;">{{ stats_global.kpis.total_items|default:"0" }}</p>
                
                <a href="{% url 'admin_ventas_globales' %}" 
                style="display: block; margin-top: 10px; font-size: 0.9em; color: #555; text-decoration: none; border-top: 1px solid #eee; padding-top: 10px;">
                    Ver ventas globales ‚Üí
                </a>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-card">
                <h3>Formatos M√°s Vendidos (Global)</h3>
                <canvas id="chartFormatosGlobal"></canvas>
            </div>
            <div class="chart-card">
                <h3>Actividad por Hora (Global)</h3>
                <canvas id="chartHorasGlobal"></canvas>
            </div>
            <div class="chart-card" style="grid-column: 1 / -1;">
                <h3>Top 5 Vendedores</h3>
                <canvas id="chartTopVendedores"></canvas>
            </div>
        </div>

    {% endif %}

</div>

<style>
    .kpi-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        text-align: center;
        border-top: 5px solid var(--color-acento);
    }

    .kpi-card h3 {
        margin: 0;
        color: #777;
        font-size: 1em;
    }

    .kpi-value {
        font-size: 2em;
        font-weight: bold;
        color: var(--color-navbar);
        margin: 10px 0;
    }

    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 30px;
    }

    .chart-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .chart-card h3 {
        text-align: center;
        margin-bottom: 15px;
        color: #555;
    }

    /* Modo Oscuro */
    body.dark-mode .kpi-card,
    body.dark-mode .chart-card {
        background-color: #2D3E2D !important;
        border-color: #444;
    }

    body.dark-mode .kpi-card h3,
    body.dark-mode .chart-card h3 {
        color: #ccc !important;
    }
</style>


// L√≠neas para que VSCode no tire error ante la mezcla de sint√°xis

{{ stats_personal.formatos.labels|json_script:"data-personal-formatos-labels" }}
{{ stats_personal.formatos.data|json_script:"data-personal-formatos-data" }}
{{ stats_personal.horas.labels|json_script:"data-personal-horas-labels" }}
{{ stats_personal.horas.data|json_script:"data-personal-horas-data" }}

{% if stats_global %}
    {{ stats_global.formatos.labels|json_script:"data-global-formatos-labels" }}
    {{ stats_global.formatos.data|json_script:"data-global-formatos-data" }}
    {{ stats_global.horas.labels|json_script:"data-global-horas-labels" }}
    {{ stats_global.horas.data|json_script:"data-global-horas-data" }}
    
    {% if top_vendedores %}
        {{ top_vendedores.labels|json_script:"data-top-labels" }}
        {{ top_vendedores.data|json_script:"data-top-data" }}
    {% endif %}
{% endif %}


<script>
    // Funci√≥n para leer los datos JSON de forma segura
    function getDjangoData(id) {
        const element = document.getElementById(id);
        return element ? JSON.parse(element.textContent) : [];
    }

    const colorPrimario = '#84AF3B'; 
    const colorSecundario = '#38761D';
    const coloresTorta = ['#84AF3B', '#38761D', '#FFCE56', '#36A2EB', '#FF6384'];

    // Funci√≥n helper para crear gr√°ficos
    function crearGrafico(canvasId, tipo, labels, data, labelSerie, colores) {
        const canvas = document.getElementById(canvasId);
        if (canvas) {
            new Chart(canvas.getContext('2d'), {
                type: tipo,
                data: {
                    labels: labels,
                    datasets: [{
                        label: labelSerie,
                        data: data,
                        backgroundColor: colores,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: tipo === 'bar' ? { y: { beginAtZero: true } } : {}
                }
            });
        }
    }

    // --- 1. CARGAR DATOS PERSONALES ---
    const pFmtLabels = getDjangoData('data-personal-formatos-labels');
    const pFmtData = getDjangoData('data-personal-formatos-data');
    const pHrsLabels = getDjangoData('data-personal-horas-labels');
    const pHrsData = getDjangoData('data-personal-horas-data');

    crearGrafico('chartFormatosPersonal', 'doughnut', pFmtLabels, pFmtData, 'Ventas', coloresTorta);
    crearGrafico('chartHorasPersonal', 'bar', pHrsLabels, pHrsData, 'Tus Ventas', colorPrimario);

    // --- 2. CARGAR DATOS GLOBALES (Si existen en el DOM) ---
    if (document.getElementById('data-global-formatos-labels')) {
        
        const gFmtLabels = getDjangoData('data-global-formatos-labels');
        const gFmtData = getDjangoData('data-global-formatos-data');
        const gHrsLabels = getDjangoData('data-global-horas-labels');
        const gHrsData = getDjangoData('data-global-horas-data');

        crearGrafico('chartFormatosGlobal', 'doughnut', gFmtLabels, gFmtData, 'Ventas Globales', coloresTorta);
        crearGrafico('chartHorasGlobal', 'bar', gHrsLabels, gHrsData, 'Ventas Globales', '#2D9CDB');
        
        // Top Vendedores
        const ctxTop = document.getElementById('chartTopVendedores');
        if (ctxTop) {
            const topLabels = getDjangoData('data-top-labels');
            const topData = getDjangoData('data-top-data');

            new Chart(ctxTop.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: topLabels,
                    datasets: [{
                        label: 'Unidades Vendidas',
                        data: topData,
                        backgroundColor: '#9B59B6',
                        borderWidth: 1
                    }]
                },
                options: { indexAxis: 'y', scales: { x: { beginAtZero: true } } }
            });
        }
    }
</script>

{% endblock %}
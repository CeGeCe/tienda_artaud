{% extends 'base.html' %}
{% load static %}

{% block title %}Cat√°logo{% endblock %}

{% block content %}

<div class="catalogo-header">
    <h1 align= center>Cat√°logo Completo</h1>
</div>

<div class="catalogo-main-container">
        
        <aside class="catalogo-sidebar">
            <h2>Filtros</h2>
            <form id="filtro-form" method="GET" action=".">
                {# Mantener los par√°metros de persistencia que NO se controlan en este formulario #}
                <input type="hidden" name="orden" value="{{ orden_actual }}">
                <input type="hidden" name="por_pagina" value="{{ por_pagina_actual }}">
                <input type="hidden" name="vista" value="{{ vista_actual }}">

                <label style="font-weight: bold; display: block; margin-top: 15px;"><u>Formato:</u></label>
                    <div style="margin-top: 5px;">
                        {% for key, display in formato_choices %}
                            <label style="display: block; margin-bottom: 5px;">
                                <input type="checkbox" name="formato" value="{{ key }}" 
                                    {% if key in formato_seleccionado %}checked{% endif %}>
                                {{ display }}
                            </label>
                        {% endfor %}
                    </div>
                
                <label style="font-weight: bold; display: block; margin-top: 15px;"><u>Condici√≥n:</u></label>
                <div style="margin-top: 5px;">
                    {% for key, display in condicion_choices %}
                        <label style="display: block; margin-bottom: 5px;">
                            <input type="checkbox" name="condicion" value="{{ key }}" 
                                {% if key in condicion_seleccionada %}checked{% endif %}>
                            {{ display }}
                        </label>
                    {% endfor %}
                </div>

                <label style="font-weight: bold; display: block; margin-top: 15px;"><u>Edici√≥n:</u></label>
                    <div style="margin-top: 5px;">
                        {% for key, display in edicion_choices %}
                            <label style="display: block; margin-bottom: 5px;">
                                <input type="checkbox" name="edicion" value="{{ key }}" 
                                    {% if key in edicion_seleccionada %}checked{% endif %}>
                                {{ display }}
                            </label>
                        {% endfor %}
                    </div>

                <label style="font-weight: bold; display: block; margin-top: 15px;">Origen:</label>
                    <div style="margin-top: 5px;">
                        <label style="display: block; margin-bottom: 5px;">
                            <input type="checkbox" name="origen" value="NACIONAL" 
                                {% if 'NACIONAL' in origen_seleccionado %}checked{% endif %}>
                            Nacional
                        </label>
                        
                        <label style="display: block; margin-bottom: 5px;">
                            <input type="checkbox" name="origen" value="IMPORTADO" 
                                {% if 'IMPORTADO' in origen_seleccionado %}checked{% endif %}>
                            Importado
                        </label>
                    </div>

                <label style="font-weight: bold; display: block; margin-top: 15px;"><u>G√©nero:</u></label>
                    <div style="margin-top: 5px;">
                        {% for key, display in genero_choices %}
                            <label style="display: block; margin-bottom: 5px;">
                                <input type="checkbox" name="genero" value="{{ key }}" 
                                    {% if key in genero_seleccionado %}checked{% endif %}>
                                {{ display }}
                            </label>
                        {% endfor %}
                    </div>
                
                <button type="submit" style="width: 100%; padding: 10px; margin-top: 20px; background-color: var(--color-navbar); color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Aplicar Filtros
                </button>
                <a href="{% url 'catalogo' %}" class="catalogo-sidebar-limpiar" style="display: block; text-align: center; margin-top: 10px;">Limpiar Filtros</a>
            </form>
        </aside>

        <section class="catalogo-productos-section">

            {% if query_actual or formato_seleccionado or condicion_seleccionada or edicion_seleccionada or genero_seleccionado %}
                <div class="search-results-header" style="text-align: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #eee;">
                    <h2 style="margin: 0; color: var(--color-texto-principal); font-size: 1.5em;">
                        Resultados para: <span style="color: var(--color-navbar); font-weight: bold;">"{{ query_actual }}"</span>
                    </h2>
                    <p style="margin: 5px 0 0 0; color: #777; font-size: 0.9em;">
                        Mostrando {{ page_obj.start_index }} - {{ page_obj.end_index }} de {{ page_obj.paginator.count }} resultados.
                    </p>
                </div>
            {% endif %}
            
            <div class="catalogo-controles-superiores">

                <div class="controles-izquierda-agrupados">
    
                    <form id="orden-form" method="GET" action="." class="orden-form" style="display: flex; align-items: center; gap: 10px;">
                        <label for="orden-select" style="font-weight: bold;">Ordenar Por:</label>
                        
                        {# Persistencia: Mantener vista, por_pagina y filtros #}
                        <input type="hidden" name="vista" value="{{ vista_actual }}">
                        <input type="hidden" name="por_pagina" value="{{ por_pagina_actual }}">
                        <input type="hidden" name="q" value="{{ query_actual|default:'' }}">
                        
                        <select name="orden" id="orden-select" onchange="document.getElementById('orden-form').submit()">
                            {% for value, display in opciones_orden %}
                                <option value="{{ value }}" {% if orden_actual == value %}selected{% endif %}>
                                    {{ display }}
                                </option>
                            {% endfor %}
                        </select>
                    </form>
                </div>

                {% if not query_actual %}
                    <p class="conteo-resultados" style="flex-grow: 1; text-align: left; font-size: 0.9em; color: #555; margin-left: 15px;">
                        Mostrando {{ page_obj.start_index }} - {{ page_obj.end_index }} de {{ page_obj.paginator.count }} productos.
                    </p>
                {% endif %}

                <div style="display: flex; align-items: center; gap: 15px;">

                    <form id="por-pagina-form" method="GET" action="." class="por-pagina-form" style="display: flex; align-items: center; gap: 10px;">
                        <label for="por-pagina-select" style="font-weight: bold;">Ver:</label>
                        
                        {# Persistencia: Mantener vista, orden y query #}
                        <input type="hidden" name="vista" value="{{ vista_actual }}">
                        <input type="hidden" name="orden" value="{{ orden_actual }}">
                        <input type="hidden" name="q" value="{{ query_actual|default:'' }}">
                        
                        <select name="por_pagina" id="por-pagina-select" onchange="document.getElementById('por-pagina-form').submit()">
                            {% for value in opciones_por_pagina %}
                                <option value="{{ value }}" {% if por_pagina_actual|stringformat:"s" == value|stringformat:"s" %}selected{% endif %}>
                                    {{ value }}
                                </option>
                            {% endfor %}
                        </select>
                    </form>

                    <div class="view-switcher">
                        <a href="?vista=cuadricula&orden={{ orden_actual }}&por_pagina={{ por_pagina_actual }}" 
                            class="view-btn {% if vista_actual == 'cuadricula' %}active{% endif %}">Cuadr√≠cula üñºÔ∏è</a>
                        <a href="?vista=lista&orden={{ orden_actual }}&por_pagina={{ por_pagina_actual }}" 
                            class="view-btn {% if vista_actual == 'lista' %}active{% endif %}">Lista üìÑ</a>
                    </div>
                </div>
            </div>


            <div class="productos-listado-container {% if vista_actual == 'cuadricula' %}grid-view{% else %}list-view{% endif %}">
                {% for producto in productos %}
                    {% if vista_actual == 'cuadricula' %}
                        {# {% include 'productos/producto_card_cuadricula.html' %} #}

                        <div class="card-producto">
                            <a href="{% url 'detalle_producto' pk=producto.pk %}" style="text-decoration: none; color: inherit; display: contents;">
                                
                                <div class="card-image-container">
                                    {% if producto.imagen_portada %}
                                        <img src="{{ producto.imagen_portada.url }}" alt="{{ producto.album }}" class="card-image">
                                    {% else %}
                                        <img src="{% static 'tienda_artaud/sin_imagen.png' %}" alt="Sin imagen" class="card-image" style="object-fit: contain;">
                                    {% endif %}
                                </div>

                                <div class="card-content">
                                    <h3>{{ producto.artista }} - {{ producto.album }}</h3>
                                    
                                    <p class="card-metadata">
                                        {{ producto.get_formato_display }} | {{ producto.get_condicion_display }}
                                    </p>
                                    
                                    <p class="card-metadata" style="margin-top: 0;">
                                        {{ producto.pais|default:"N/A" }} | {{ producto.sello|default:"N/A" }}
                                    </p>
                                </div>

                                <div class="card-footer">
        
                                    <div class="producto-vendedor">
                                        Publicado por:<br>
                                        <a href="{% url 'ver_vendedor' username=producto.vendedor.username %}" 
                                        style="color: var(--color-navbar); font-weight: bold; text-decoration: none;">
                                        {{ producto.vendedor.username }}
                                        </a>
                                    </div>

                                    <div class="price-wrapper">
                                        <span class="producto-precio-label">Precio:</span>
                                        <span class="producto-precio">${{ producto.precio|floatformat:2 }}</span>
                                    </div>
                                </div>
                            </a>
                        </div>

                    {% else %}

                        <div class="list-item-producto">

                            <a href="{% url 'detalle_producto' pk=producto.pk %}" style="display: flex; text-decoration: none; color: inherit; width: 100%; padding: 15px; align-items: center;">

                                <div class="list-image-container">
                                    {% if producto.imagen_portada %}
                                        <img src="{{ producto.imagen_portada.url }}" alt="{{ producto.album }}" class="card-image">
                                    {% else %}
                                        <img src="{% static 'tienda_artaud/sin_imagen.png' %}" alt="Sin imagen" class="card-image" style="object-fit: contain;">
                                    {% endif %}
                                </div>

                                <div class="list-details" style="flex-grow: 1; padding: 0 20px;">
                                    <h3 style="margin: 0 0 5px 0; font-size: 1.3em; color: var(--color-acento);">
                                        {{ producto.artista }}
                                    </h3>
                                    <h4 style="margin: 0 0 10px 0; font-size: 1.2em; font-weight: normal;">
                                        {{ producto.album }}
                                    </h4>

                                    <p style="margin: 0; font-size: 0.9em; color: #777;">
                                        {{ producto.get_formato_display }} | {{ producto.get_condicion_display }}
                                    </p>
                                    <p style="margin: 5px 0 0 0; font-size: 0.9em; color: #777;">
                                        Pa√≠s: {{ producto.pais|default:"N/A" }} | Sello: {{ producto.sello|default:"N/A" }}
                                    </p>
                                </div>

                                <div class="list-price-action" style="text-align: right; min-width: 150px; display: flex; flex-direction: column; justify-content: space-between; height: 100px;">
                
                                    <div>
                                        <span style="display: block; font-size: 0.8em; color: #999; font-weight: bold;">Precio:</span>
                                        <span style="font-size: 1.6em; font-weight: bold; color: var(--color-acento);">${{ producto.precio|floatformat:2 }}</span>
                                    </div>

                                    <div style="font-size: 0.85em; margin-top: auto;">
                                        <span style="color: #777;">Publicado por:</span>
                                        <span style="font-weight: bold; color: var(--color-navbar);">{{ producto.vendedor.username }}</span>
                                    </div>

                                </div>
                            </a>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>

            <div class="pagination-container">
                {# Usamos un include para la paginaci√≥n, pasando todos los par√°metros GET #}
                {% include 'productos/pagination.html' with page_obj=page_obj query_actual=query_actual orden_actual=orden_actual vista_actual=vista_actual por_pagina_actual=por_pagina_actual %}
            </div>

        </section>
    </div>

{% endblock content %}
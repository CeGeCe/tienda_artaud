{% load static %}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Radio Artaud üìª</title>
    <style>
        body {
            background-color: #1E281E; /* Verde oscuro Artaud */
            color: white;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
            user-select: none;
            transition: height 0.3s ease;
        }

        .player-container {
            width: 100%;
            max-width: 340px;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }

        /* Disco giratorio */
        .album-art {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            background-image: url("{% static 'tienda_artaud/icons/cd_icon.jpg' %}");
            background-size: cover;
            background-position: center;
            margin: 0 auto 15px auto;
            box-shadow: 0 0 25px rgba(0,0,0,0.6);
            border: 4px solid #333;
            animation: spin 10s linear infinite;
            animation-play-state: paused; /* Pausado por defecto */
        }

        @keyframes spin { 100% { transform: rotate(360deg); } }
        .running { animation-play-state: running; }

        /* Textos */
        h2 { margin: 0; font-size: 1.1em; color: #A4E58E; margin-bottom: 5px }

        .artist-name { margin: 0; font-size: 1em; font-weight: bold; color: white }

        .album-name { margin: 2px 0 15px 0; font-size: 0.9em; color: #999; font-style: italic; }


        /* Bot√≥n Buscar en Tienda */
        .btn-search-store {
            background-color: transparent;
            border: 1px solid #A4E58E;
            color: #A4E58E;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8em;
            cursor: pointer;
            margin-bottom: 15px;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }
        .btn-search-store:hover {
            background-color: #A4E58E;
            color: #1E281E;
        }

        /* Barra de progreso */
        .progress-area {
            width: 100%;
            padding: 10px 0;
            cursor: pointer;
        }

        .progress-container {
            width: 100%;
            background: #444;
            height: 8px;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #A4E58E, #4B9A27);
            width: 0%;
            border-radius: 10px;
            transition: width 0.1s linear;
        }

        /* Controles */
        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 25px;
            margin: 15px 0;
        }

        .btn-control {
            background: none;
            border: none;
            color: white;
            font-size: 1.8em;
            cursor: pointer;
            transition: transform 0.1s, color 0.2s;
            padding: 0;
        }
        .btn-control:hover { color: #A4E58E; transform: scale(1.1); }
        .btn-control:active { transform: scale(0.9); }
        .btn-play { font-size: 3.5em; }

        .volume-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .mute-btn { cursor: pointer; font-size: 1.2em; user-select: none; }
        .mute-btn:hover { color: #A4E58E; }

        input[type=range] {
            -webkit-appearance: none; /* Quitar estilo por defecto */
            appearance: none;
            width: 60%;
            background: transparent;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #A4E58E;
            cursor: pointer;
            margin-top: -6px; /* Centrar verticalmente */
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            background: #555;
            border-radius: 5px;
        }

        /* ‚ö†Ô∏è Bot√≥n Toggle Playlist */
        .btn-toggle-list {
            background: none; border: none; color: #777; font-size: 0.9em; cursor: pointer; margin-top: 5px; border-bottom: 1px dashed #555;
        }
        .btn-toggle-list:hover { color: white; }

        /* Playlist (Oculta por defecto o visible seg√∫n JS) */
        .playlist-container {
            display: none; /* Oculto por defecto para ahorrar espacio */
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .playlist-container.visible { display: block; opacity: 1; }

        /* Lista de canciones */
        .playlist {
            list-style: none;
            padding: 0;
            text-align: left;
            height: 180px; /* Mostrar + o - canciones de la playlist */
            overflow-y: auto;
            border-top: 1px solid #333;
            border-bottom: 1px solid #333;
            margin-top: 10px;
        }
        .playlist li {
            padding: 10px;
            border-bottom: 1px solid #2a2a2a;;
            cursor: pointer;
            font-size: 0.85em;
            color: #aaa;
        }
        .playlist li:hover { background-color: #2a3a2a; color: white; }
        .playlist li.active { color: #A4E58E; font-weight: bold; background-color: #222; border-left: 3px solid #A4E58E;}

        /* Scrollbar bonita */
        .playlist::-webkit-scrollbar { width: 5px; }
        .playlist::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }

    </style>
</head>

<body>

    <div class="player-container">
        <div class="album-art" id="albumArt"></div>
        
        <h2 id="songTitle">Cargando...</h2>

        <p id="artistName">Artista</p>
        <p id="albumName" class="album-name">√Ålbum</p>

        <button onclick="searchInStore()" class="btn-search-store" title="Buscar este √°lbum en la tienda">
            Buscar en Tienda üîç
        </button>

        <div class="progress-area" id="progressArea">
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
        </div>

        <div class="controls">
            <button class="btn-control" onclick="prevSong()" title="Anterior">‚èÆ</button>
            <button class="btn-control btn-play" onclick="togglePlay()" id="playBtn" title="Reproducir">‚ñ∂</button>
            <button class="btn-control" onclick="nextSong()" title="Siguiente">‚è≠</button>
        </div>
        
        <div class="volume-container">
            <span class="mute-btn" id="muteIcon" onclick="toggleMute()" title="Silenciar">üîá</span>

            <input type="range" min="0" max="1" step="0.05" id="volSlider" oninput="setVolume(this.value)" title="Volumen">
        </div>

        <button class="btn-toggle-list" onclick="togglePlaylist()">Mostrar/Ocultar Lista ‚ò∞</button>

        <div id="playlistBox" class="playlist-container">
            <ul class="playlist" id="playlistElement"></ul>
        </div>

    </div>

    <audio id="audioPlayer"></audio>

    <script>
        // DATOS DE LA PLAYLIST (NO LEE METADATA)
        const songs = [
            {
                title: "Neverender",
                artist: "Justice",
                album: "Hyperdrama",
                src: "{% static 'tienda_artaud/audio/tema_01.mp3' %}" 
            },
            {
                title: "Post-Crucifixi√≥n", 
                artist: "Pescado Rabioso", 
                album: "Obras Cumbres",
                src: "{% static 'tienda_artaud/audio/tema_02.mp3' %}" 
            },

            {
                title: "I Sat By The Ocean", 
                artist: "Queens of the Stone Age",
                album: "...Like Clockwork",
                src: "{% static 'tienda_artaud/audio/tema_03.mp3' %}" 
            },

            {
                title: "Rock DJ", 
                artist: "Robbie Williams", 
                album: "Better Man",
                src: "{% static 'tienda_artaud/audio/tema_04.mp3' %}" 
            },
            {
                title: "IRIS OUT", 
                artist: "Kenshi Yonezu", 
                album: "IRIS OUT",
                src: "{% static 'tienda_artaud/audio/tema_05.mp3' %}" 
            },

            {
                title: "iPod Touch", 
                artist: "Ninajirachi", 
                album: "I Love My Computer",
                src: "{% static 'tienda_artaud/audio/tema_06.mp3' %}"
            },

            {
                title: "As Alive As You Need Me To Be", 
                artist: "Nine Inch Nails", 
                album: "Tron: Ares",
                src: "{% static 'tienda_artaud/audio/tema_07.mp3' %}" 
            },
        ];
        
        // VOLUMEN INICIAL (hasta 1.0)
        let currentVolume = 0.2; 

        let currentIndex = 0;
        let isMuted = false;
        let previousVolume = currentVolume;

        const audio = document.getElementById('audioPlayer');
        
        const albumArt = document.getElementById('albumArt');
        const progressBar = document.getElementById('progressBar');
        const playBtn = document.getElementById('playBtn');

        // Info Canci√≥n
        const title = document.getElementById('songTitle');
        const artist = document.getElementById('artistName');
        const album = document.getElementById('albumName');
        
        const volSlider = document.getElementById('volSlider');
        const muteIcon = document.getElementById('muteIcon');

        const playlistBox = document.getElementById('playlistBox');
        const playlistElement = document.getElementById('playlistElement');

        
        // --- FUNCIONES DE VENTANA Y LISTA ---
        function togglePlaylist() {
            // Si est√° oculto, lo mostramos y agrandamos la ventana
            if (playlistBox.style.display === 'none' || playlistBox.style.display === '') {
                playlistBox.style.display = 'block';
                setTimeout(() => playlistBox.classList.add('visible'), 10); // Efecto fade
                
                // Redimensionar Ventana: M√°s alta
                window.resizeTo(420, 850); 
            } else {
                // Si est√° visible, lo ocultamos y achicamos la ventana
                playlistBox.classList.remove('visible');
                setTimeout(() => playlistBox.style.display = 'none', 300);
                
                // Redimensionar Ventana: M√°s chica
                window.resizeTo(400, 700);
            }
        }

        // --- FUNCIONES DE AUDIO ---
        function setVolume(vol) {
            currentVolume = vol;
            audio.volume = currentVolume;
            
            // Actualizar √≠cono seg√∫n nivel
            if (vol == 0) {
                muteIcon.innerText = 'üîá';
                isMuted = true;
            } else {
                muteIcon.innerText = 'üîâ';
                isMuted = false;
            }
        }

        function toggleMute() {
            if (isMuted) {
                // Desmutear (volver al volumen anterior)
                setVolume(previousVolume > 0 ? previousVolume : 0.2);
                volSlider.value = audio.volume;
            } else {
                // Mutear
                previousVolume = audio.volume; // Guardar valor actual
                setVolume(0);
                volSlider.value = 0;
            }
        }


        // BUSCAR EN LA TIENDA
        function searchInStore() {
            const currentSong = songs[currentIndex];
            
            // 1. Unir Artista y √Ålbum
            let rawTerm = `${currentSong.artist} ${currentSong.album}`;

            // 2. LIMPIEZA DE CARACTERES ESPECIALES
            // Bbusca: puntos, dos puntos, comas, guiones, par√©ntesis
            // y los reemplaza por un espacio en blanco.
            // /[.:,;()\-]/g  <-- Esto es el "Regex"
            let cleanTerm = rawTerm.replace(/[.:,;()\-]/g, " ");

            // 3. Limpiar espacios dobles que hayan quedado
            // (Ej: si se borra "..." quedan 3 espacios, luego se convierte en 1)
            cleanTerm = cleanTerm.replace(/\s+/g, " ").trim();
            
            // Codificar para la URL
            const query = encodeURIComponent(cleanTerm);
            
            // URL del Cat√°logo
            const searchUrl = `/catalogo/?q=${query}`;


            // L√≥gica para controlar la ventana padre (opener)
            // PUEDE NO FUNCIONAR
            if (window.opener && !window.opener.closed) {
                // Si la tienda sigue abierta, cambiar la URL
                window.opener.location.href = searchUrl;
                window.opener.focus(); // Trae la ventana al frente
            } else {
                // Si la tienda se cerr√≥, abre una nueva pesta√±a
                window.open(searchUrl, '_blank');
            }
        }


        // Cargar lista
        function loadPlaylist() {
            playlistElement.innerHTML = '';
            songs.forEach((song, index) => {
                const li = document.createElement('li');
                li.innerText = `${index + 1}. ${song.title}`;
                li.onclick = () => loadSong(index);
                if (index === currentIndex) li.classList.add('active');
                playlistElement.appendChild(li);
            });
            // Auto-scroll para mostrar la canci√≥n activa
            const activeLi = playlistElement.querySelector('.active');
            if(activeLi) activeLi.scrollIntoView({ behavior: "smooth", block: "center" });
        }

        // Cargar datos de la canci√≥n
        function loadSong(index) {
            currentIndex = index;
            title.innerText = songs[index].title;
            artist.innerText = songs[index].artist;
            album.innerText = songs[index].album;
            
            // Solo cambia el src si es diferente para evitar recargas innecesarias
            if (audio.getAttribute('src') !== songs[index].src) {
                audio.src = songs[index].src;
            }
            
            // Actualizar estilo de lista
            loadPlaylist();
            playSong();
        }

        function playSong() {
            audio.play().catch(e => console.log("Esperando interacci√≥n usuario")); 
            playBtn.innerText = '‚è∏';
            albumArt.classList.add('running');
        }

        function pauseSong() {
            audio.pause();
            playBtn.innerText = '‚ñ∂';
            albumArt.classList.remove('running');
        }

        function togglePlay() {
            if (audio.paused) playSong();
            else pauseSong();
        }

        function nextSong() {
            currentIndex = (currentIndex + 1) % songs.length;
            loadSong(currentIndex);
        }

        function prevSong() {
            currentIndex = (currentIndex - 1 + songs.length) % songs.length;
            loadSong(currentIndex);
        }

        // Actualizar barra de progreso
        audio.addEventListener('timeupdate', () => {
            if (audio.duration) {
                const percent = (audio.currentTime / audio.duration) * 100;
                progressBar.style.width = `${percent}%`;
            }
        });
        
        // Clic en la barra de progreso (Saltar a tiempo)
        document.getElementById('progressArea').addEventListener('click', (e) => {
            const width = e.currentTarget.clientWidth; // Ancho total del √°rea
            const clickX = e.offsetX; // D√≥nde se hizo clic
            const duration = audio.duration;
            
            if (duration) {
                audio.currentTime = (clickX / width) * duration;
            }
        });

        // Siguiente autom√°tico
        audio.addEventListener('ended', nextSong);

        // Carga inicial (sin autoplay para evitar bloqueo de navegador)
        title.innerText = songs[0].title;
        artist.innerText = songs[0].artist;
        artist.innerText = songs[0].album;
        audio.src = songs[0].src;

        audio.volume = currentVolume;
        volSlider.value = currentVolume;

        loadPlaylist();
        
        // Iniciar con ventana peque√±a (lista oculta)
        // Nota: Los navegadores modernos bloquean resizeTo si no es un popup creado por script.
        // Como esto se abre desde 'base.html' con window.open, deber√≠a funcionar.
        try { window.resizeTo(420, 700); } catch(e) {}

    </script>

</body>
</html>